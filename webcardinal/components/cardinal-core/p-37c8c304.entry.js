import{r as e,h as t,g as s}from"./p-986eab93.js";import"./p-5ace585b.js";import{B as i}from"./p-56f4526a.js";import{C as r}from"./p-8c9363d6.js";import"./p-66bf9afb.js";import{T as n}from"./p-83aa5881.js";let o=new class{setIdentity(e){this.identity=e}setSSAppPage(e){this.ssAppPage=e}getSSAppPage(){return this.ssAppPage?this.ssAppPage:this.identity}listenForSSAppHistoryChanges(){window.document.addEventListener("ssapp-history-changed",(e=>{let t=e.detail;t.ssappPageUrl&&this.setSSAppPage(this.identity+t.ssappPageUrl);let s="~"+this.getSSAppPage();t.childRoute&&(s+=t.childRoute);let i=t.ssappPageUrl?t.ssappPageUrl:t.currentPageTitle;console.log(s,i),this.notifyParentForChanges({currentPageTitle:i,childRoute:s})}))}notifyParentForChanges(e){(()=>{try{return window.self!==window.parent}catch(e){return!1}})()&&window.parent.document.dispatchEvent(new CustomEvent("ssapp-history-changed",{detail:e}))}};const a=function(){return o};let p=new class{constructor(){this.registry=[],window.$$&&$$.SSAPP_CONTEXT&&$$.SSAPP_CONTEXT.BASE_URL&&$$.SSAPP_CONTEXT.SEED||(void 0===$$.flows&&require("callflow").initialise(),void 0===$$.swarms?require("swarm-engine").initialise("wallet"):$$.swarmEngine.updateIdentity("wallet"))}addSSAppReference(e,t){console.log("registering ssapp",e,t),void 0!==this.registry[e]&&this.registry[e]!==t?console.log("Replacing a reference."):function(e,t){let s=new(0,require("swarm-engine").SSAppPowerCord)(t.contentWindow);$$.swarmEngine.plug(e,s)}(e,t),this.registry[e]=t}removeSSAppReference(e){void 0!==this.registry[e]&&(delete this.registry[e],$$.swarmEngine.unplug(e))}getSSAppReference(e){return this.registry[e]}};var h=function(e,t,s,i){var r,n=arguments.length,o=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,s,o):r(t,s))||o);return n>3&&o&&Object.defineProperty(t,s,o),o};const d=class{constructor(t){e(this,t),this.seed=null,this.componentInitialized=!1}connectedCallback(){navigator.serviceWorker.addEventListener("message",this.__getSWOnMessageHandler())}disconnectedCallback(){navigator.serviceWorker.removeEventListener("message",this.__getSWOnMessageHandler())}componentShouldUpdate(e,t,s){return e!==t&&("digestKeySsiHex"===s||"parsedParams"===s)&&(window.document.removeEventListener(t,this.eventHandler),window.document.addEventListener(e,this.eventHandler),!0)}componentWillLoad(){if(this.element.isConnected)return new Promise((e=>{this.componentInitialized=!0,this.loadApp(e)}))}componentDidLoad(){let e=this.element.querySelector("iframe");console.log("#### Trying to register ssapp reference"),p.addSSAppReference(this.appName,e),this.eventHandler=this.__ssappEventHandler.bind(this),window.document.addEventListener(this.digestKeySsiHex,this.eventHandler),window.document.addEventListener(this.parsedParams,this.eventHandler),a().listenForSSAppHistoryChanges()}loadApp(e){if(this.__hasRelevantMatchParams()&&(this.seed=this.match.params.keySSI),this.componentInitialized&&(this.digestKeySsiHex=this.__digestMessage(this.seed),a().setIdentity(this.digestKeySsiHex),"function"==typeof e&&e(),null!=this.params&&null!=this.params))try{this.parsedParams=JSON.parse(this.params)}catch(e){console.log("Attribute called 'params' could not be parsed.")}}render(){let e,s=window.parent,i=window;try{for(;i!==s;)e=s.location.origin+s.location.pathname,i=s,s=s.parent}catch(e){}finally{e=i.location.origin+i.location.pathname,e=e.replace("index.html",""),"/"!==e[e.length-1]&&(e+="/");let s="?";this.parsedParams&&(s+=Object.keys(this.parsedParams).map((e=>e+"="+this.parsedParams[e])).join("&"));const r=e+"iframe/"+($$.SSAPP_CONTEXT&&$$.SSAPP_CONTEXT.BASE_URL&&$$.SSAPP_CONTEXT.SEED?this.seed:this.digestKeySsiHex)+(s.length>1?s:"");return console.log("Loading sssap in: "+r),t("iframe",{"landing-page":this.landingPath,frameborder:"0",style:{overflow:"hidden",height:"100%",width:"100%"},src:r})}}___sendLoadingProgress(e,t){let s=window,i=s.parent;for(;s!==i;)s=i,i=s.parent;i.document.dispatchEvent(new CustomEvent("ssapp:loading:progress",{detail:{progress:e,status:t}}))}__hasRelevantMatchParams(){return this.match&&this.match.params&&this.match.params.keySSI}__ssappEventHandler(e){const t=e.detail||{};let s=this.element.querySelector("iframe");if("seed"!==t.query){if("completed"===t.status){const e=()=>{this.___sendLoadingProgress(100),s.removeEventListener("load",e)};s.addEventListener("load",e),s.contentWindow.location.reload()}}else s.contentWindow.document.dispatchEvent(new CustomEvent(this.digestKeySsiHex,{detail:{seed:this.seed}}))}__getSWOnMessageHandler(){return this.__onServiceWorkerMessageHandler||(this.__onServiceWorkerMessageHandler=e=>{e.data&&"seed"===e.data.query&&e.data.identity===this.digestKeySsiHex&&e.source.postMessage({seed:this.seed})}),this.__onServiceWorkerMessageHandler}__digestMessage(e){return require("opendsu").loadApi("crypto").sha256(e)}get element(){return s(this)}static get watchers(){return{seed:["loadApp"],params:["loadApp"],match:["loadApp"],landingPath:["loadApp"]}}};h([i()],d.prototype,"modelHandler",void 0),h([r(),n({isMandatory:!0,description:["This property represents the name of the Self Sovereign Application that you want to run."],propertyType:"string"})],d.prototype,"appName",void 0),h([n({isMandatory:!1,description:"This property keeps should have 2 keys: currentDossierPath and fullPath",propertyType:"string"})],d.prototype,"seed",void 0),h([n({isMandatory:!0,description:"This property represents the direct path that will be passed to the Iframe as the landing-page property.",propertyType:"string"})],d.prototype,"landingPath",void 0),h([n({isMandatory:!1,description:"This property represents the query params of the Iframe.",propertyType:"string"})],d.prototype,"params",void 0);export{d as psk_ssapp}